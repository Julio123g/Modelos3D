<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor AR - Plano de Apartamento</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        model-viewer {
            width: 100%;
            height: 100%;
            background-color: transparent;
            --poster-color: transparent;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .ar-button {
            background: linear-gradient(145deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
            transition: all 0.3s ease;
            display: none;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ar-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(255, 107, 107, 0.4);
        }

        .ar-button:active {
            transform: translateY(0);
        }

        .style-controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            gap: 10px;
            min-width: 280px;
        }

        .style-controls.show {
            display: flex;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .color-input {
            width: 100%;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .model-selector {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .model-selector:hover {
            border-color: #667eea;
        }

        .model-selector:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        .toggle-styles {
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .toggle-styles:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.3);
        }

        .status-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            transition: all 0.3s ease;
            max-width: 90%;
            text-align: center;
        }

        .status-message.info {
            background: linear-gradient(145deg, #4CAF50, #45a049);
        }

        .status-message.warning {
            background: linear-gradient(145deg, #ff9800, #f57c00);
        }

        .status-message.error {
            background: linear-gradient(145deg, #f44336, #d32f2f);
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            z-index: 1002;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .loading.show {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .style-controls {
                min-width: 250px;
                padding: 12px 15px;
            }
            
            .ar-button {
                padding: 12px 25px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <model-viewer
            id="model-viewer-element"
            src="apartment_floor_plan.glb"
            alt="Plano 3D de apartamento"
            ar
            ar-modes="webxr scene-viewer quick-look"
            camera-controls
            touch-action="pan-y"
            auto-rotate
            auto-rotate-delay="3000"
            rotation-per-second="30deg"
            environment-image="neutral"
            shadow-intensity="1"
            shadow-softness="0.5"
        >
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Cargando modelo 3D...</p>
            </div>
        </model-viewer>

        <div class="controls">
            <div class="style-controls" id="style-controls">
                <div class="control-group">
                    <label for="model-selector">üè† Seleccionar Modelo:</label>
                    <select id="model-selector" class="model-selector">
                        <option value="apartment_floor_plan.glb">Plano de Apartamento</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="bg-color">Color de Fondo:</label>
                    <input type="color" id="bg-color" class="color-input" value="#667eea">
                </div>
                
                <div class="control-group">
                    <label for="light-color">Color de Luz:</label>
                    <input type="color" id="light-color" class="color-input" value="#ffffff">
                </div>
                
                <div class="control-group">
                    <label for="shadow-color">Color de Sombra:</label>
                    <input type="color" id="shadow-color" class="color-input" value="#000000">
                </div>
                
                <button class="toggle-styles" onclick="toggleStyleControls()">Ocultar Estilos</button>
            </div>
            
            <button class="toggle-styles" id="show-styles" onclick="toggleStyleControls()">üé® Personalizar</button>
            <button class="ar-button" id="ar-button">üöÄ Ver en AR</button>
        </div>
    </div>

    <script>
        class ARViewer {
            constructor() {
                this.modelViewer = document.querySelector('#model-viewer-element');
                this.arButton = document.querySelector('#ar-button');
                this.styleControls = document.querySelector('#style-controls');
                this.showStylesBtn = document.querySelector('#show-styles');
                this.loading = document.querySelector('#loading');
                this.modelSelector = document.querySelector('#model-selector');
                
                // Lista de modelos a detectar autom√°ticamente
                this.possibleModels = [
                    'apartment_floor_plan.glb',
                    'model1.glb',
                    'model2.glb',
                    'model3.glb',
                    'model4.glb',
                    'model5.glb',
                    'house_plan.glb',
                    'office_plan.glb',
                    'building.glb',
                    'floor_plan.glb'
                ];
                
                this.availableModels = [];
                
                this.init();
            }

            init() {
                this.detectAvailableModels();
                this.setupEventListeners();
                this.checkARSupport();
                this.setupStyleControls();
            }

            setupEventListeners() {
                // Eventos del modelo
                this.modelViewer.addEventListener('load', () => {
                    this.hideLoading();
                    this.showStatusMessage('Modelo cargado correctamente', 'info', 3000);
                });

                this.modelViewer.addEventListener('error', (event) => {
                    this.hideLoading();
                    this.showStatusMessage('Error al cargar el modelo', 'error', 5000);
                    console.error('Error loading model:', event);
                });

                // Eventos AR
                this.modelViewer.addEventListener('ar-status', (event) => {
                    this.handleARStatus(event.detail.status);
                });

                this.arButton.addEventListener('click', () => {
                    this.activateAR();
                });

                // Mostrar loading inicialmente
                this.showLoading();
            }

            async checkARSupport() {
                try {
                    // M√∫ltiples m√©todos de detecci√≥n para Samsung
                    const checks = [
                        this.checkWebXR(),
                        this.checkSceneViewer(),
                        this.checkUserAgent(),
                        this.checkARCore()
                    ];

                    const results = await Promise.allSettled(checks);
                    const hasAnySupport = results.some(result => 
                        result.status === 'fulfilled' && result.value === true
                    );

                    // Esperar a que model-viewer termine de cargar
                    await this.waitForModelViewer();

                    // Verificaci√≥n adicional con model-viewer
                    const modelViewerSupport = this.modelViewer.canActivateAR;

                    if (hasAnySupport || modelViewerSupport) {
                        this.enableARButton();
                    } else {
                        this.showStatusMessage('Dispositivo sin soporte AR - Modo visualizaci√≥n 3D', 'warning', 4000);
                    }
                } catch (error) {
                    console.error('Error checking AR support:', error);
                    this.showStatusMessage('Error al verificar soporte AR', 'error', 3000);
                }
            }

            async checkWebXR() {
                if ('xr' in navigator) {
                    try {
                        const session = await navigator.xr.isSessionSupported('immersive-ar');
                        return session;
                    } catch (e) {
                        return false;
                    }
                }
                return false;
            }

            checkSceneViewer() {
                return new Promise((resolve) => {
                    // Android Scene Viewer check
                    const isAndroid = /Android/i.test(navigator.userAgent);
                    if (isAndroid) {
                        const chromeVersion = this.getChromeVersion();
                        resolve(chromeVersion >= 70);
                    } else {
                        resolve(false);
                    }
                });
            }

            checkUserAgent() {
                return new Promise((resolve) => {
                    const ua = navigator.userAgent.toLowerCase();
                    const isCompatible = (
                        ua.includes('android') && 
                        (ua.includes('chrome') || ua.includes('samsung')) &&
                        !ua.includes('firefox')
                    );
                    resolve(isCompatible);
                });
            }

            async checkARCore() {
                return new Promise((resolve) => {
                    // Verificaci√≥n espec√≠fica para dispositivos Samsung con ARCore
                    const ua = navigator.userAgent;
                    const isSamsung = ua.includes('SM-') || ua.includes('samsung');
                    const isModernAndroid = this.getAndroidVersion() >= 7.0;
                    
                    if (isSamsung && isModernAndroid) {
                        // Samsung con Android 7+ probablemente soporta ARCore
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                });
            }

            waitForModelViewer() {
                return new Promise((resolve) => {
                    if (this.modelViewer.loaded) {
                        resolve();
                    } else {
                        this.modelViewer.addEventListener('load', resolve, { once: true });
                    }
                });
            }

            getChromeVersion() {
                const match = navigator.userAgent.match(/Chrome\/(\d+)/);
                return match ? parseInt(match[1]) : 0;
            }

            getAndroidVersion() {
                const match = navigator.userAgent.match(/Android (\d+(?:\.\d+)?)/);
                return match ? parseFloat(match[1]) : 0;
            }

            enableARButton() {
                this.arButton.style.display = 'block';
                this.showStatusMessage('¬°AR disponible! Toca el bot√≥n para comenzar', 'info', 4000);
            }

            handleARStatus(status) {
                switch (status) {
                    case 'not-presenting':
                        this.arButton.textContent = 'üöÄ Ver en AR';
                        break;
                    case 'session-started':
                        this.arButton.textContent = 'üîÑ Salir de AR';
                        this.showStatusMessage('¬°Sesi√≥n AR iniciada!', 'info', 2000);
                        break;
                    case 'object-placed':
                        this.showStatusMessage('Modelo colocado en AR', 'info', 2000);
                        break;
                    case 'failed':
                        this.showStatusMessage('Error al iniciar AR', 'error', 3000);
                        break;
                }
            }

            activateAR() {
                try {
                    this.modelViewer.activateAR();
                } catch (error) {
                    console.error('Error activating AR:', error);
                    this.showStatusMessage('Error al activar AR', 'error', 3000);
                }
            }

            setupStyleControls() {
                const bgColor = document.getElementById('bg-color');
                const lightColor = document.getElementById('light-color');
                const shadowColor = document.getElementById('shadow-color');

                // Selector de modelo
                this.modelSelector.addEventListener('change', (e) => {
                    this.changeModel(e.target.value);
                });

                bgColor.addEventListener('change', (e) => {
                    document.body.style.background = `linear-gradient(135deg, ${e.target.value}, ${this.darkenColor(e.target.value, 20)})`;
                });

                lightColor.addEventListener('change', (e) => {
                    this.modelViewer.style.setProperty('--neutral-lighting', e.target.value);
                });

                shadowColor.addEventListener('change', (e) => {
                    this.modelViewer.style.setProperty('--shadow-color', e.target.value);
                });
            }

            darkenColor(color, percent) {
                const num = parseInt(color.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) - amt;
                const G = (num >> 8 & 0x00FF) - amt;
                const B = (num & 0x0000FF) - amt;
                return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
            }

            showStatusMessage(message, type = 'info', duration = 3000) {
                const existingMessage = document.querySelector('.status-message');
                if (existingMessage) {
                    existingMessage.remove();
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = `status-message ${type}`;
                messageDiv.textContent = message;
                document.body.appendChild(messageDiv);

                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, duration);
            }

            showLoading() {
                this.loading.classList.add('show');
            }

            hideLoading() {
                this.loading.classList.remove('show');
            }

            async detectAvailableModels() {
                this.showStatusMessage('Detectando modelos disponibles...', 'info', 2000);
                
                for (const modelFile of this.possibleModels) {
                    try {
                        const response = await fetch(modelFile, { method: 'HEAD' });
                        if (response.ok) {
                            this.availableModels.push({
                                file: modelFile,
                                name: this.getModelDisplayName(modelFile)
                            });
                        }
                    } catch (error) {
                        // El modelo no existe, continuar con el siguiente
                        console.log(`Modelo ${modelFile} no encontrado`);
                    }
                }

                this.populateModelSelector();
            }

            getModelDisplayName(filename) {
                const nameMap = {
                    'apartment_floor_plan.glb': 'üè† Plano de Apartamento',
                    'model1.glb': 'üè¢ Modelo 1',
                    'model2.glb': 'üèòÔ∏è Modelo 2', 
                    'model3.glb': 'üè≠ Modelo 3',
                    'model4.glb': 'üè¨ Modelo 4',
                    'model5.glb': 'üè™ Modelo 5',
                    'house_plan.glb': 'üè° Plano de Casa',
                    'office_plan.glb': 'üè¢ Plano de Oficina',
                    'building.glb': 'üèóÔ∏è Edificio',
                    'floor_plan.glb': 'üìê Plano General'
                };
                
                return nameMap[filename] || `üìã ${filename.replace('.glb', '').replace('_', ' ').toUpperCase()}`;
            }

            populateModelSelector() {
                // Limpiar selector
                this.modelSelector.innerHTML = '';
                
                if (this.availableModels.length === 0) {
                    // Si no hay modelos, agregar solo el predeterminado
                    this.availableModels.push({
                        file: 'apartment_floor_plan.glb',
                        name: 'üè† Plano de Apartamento (Por defecto)'
                    });
                }
                
                // Poblar selector
                this.availableModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.file;
                    option.textContent = model.name;
                    this.modelSelector.appendChild(option);
                });

                const modelCount = this.availableModels.length;
                if (modelCount > 1) {
                    this.showStatusMessage(`${modelCount} modelos encontrados`, 'info', 3000);
                }
            }

            changeModel(modelFile) {
                this.showLoading();
                this.showStatusMessage(`Cargando ${this.getModelDisplayName(modelFile)}...`, 'info', 2000);
                
                // Cambiar el atributo src del model-viewer
                this.modelViewer.src = modelFile;
                
                // Actualizar el alt text
                this.modelViewer.alt = `Modelo 3D: ${this.getModelDisplayName(modelFile)}`;
            }
        }

        // Funciones globales para los controles
        function toggleStyleControls() {
            const controls = document.getElementById('style-controls');
            const showBtn = document.getElementById('show-styles');
            
            if (controls.classList.contains('show')) {
                controls.classList.remove('show');
                showBtn.style.display = 'block';
            } else {
                controls.classList.add('show');
                showBtn.style.display = 'none';
            }
        }

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            new ARViewer();
        });

        // Manejo de errores globales
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
</body>
</html>
